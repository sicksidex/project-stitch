<!DOCTYPE html>
<html>
<head>
    <title>Experiment</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map_canvas {
            height: 100%;
        }
    </style>
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?sensor=true">
    </script>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.2.min.js"></script>
    <script type="text/javascript">

        function initialize() {
            var socket = new WebSocket("ws://192.168.0.16:8182");
            var zoomMaster = 5;
            var mDPI;
            var mWidthInch;
            var mHeightInch;
            var totalWidthL = 0;
            var totalWidthR = 0;
            var devicesCount = 0;

            var stage = new Kinetic.Stage({
                container: 'control',
                width: window.innerWidth,
                height: window.innerHeight
            });
            var boxLayer = new Kinetic.Layer();
            var boxArray = [];
            boxLayer.setScale(0.001, 0.001)
            

            var mapOptions = {
                center: new google.maps.LatLng(-34.397433, 150.111),
                zoom: zoomMaster,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: true
            };
            var map = new google.maps.Map(document.getElementById("map_canvas"),
                mapOptions);

            getDimensions();
            socket.onopen = function () { };
            socket.onmessage = function (msg) { recieve(msg.data); };

            google.maps.event.addListener(map, 'center_changed', function () { recenterMaps(); });

            google.maps.event.addListener(map, 'zoom_changed', function () {
                zoomMaster = map.getZoom();
                recenterMaps();
            });

            google.maps.event.addListener(map, 'maptypeid_changed', function () {
                var mapType = map.getMapTypeId();
                send("lay," + mapType);
            });

            function getDimensions() {
                var p = window.devicePixelRatio;
                var mWidthPixel = window.screen.width * p;
                var mHeightPixel = window.screen.height * p;
                mDPI = p * 155;
                mWidthInch = mWidthPixel / mDPI;
                mHeightInch = mHeightPixel / mDPI;
                addDevice(mWidthInch.toFixed(4) * 10000, mHeightInch.toFixed(4) * 10000);
                devicesCount++;
            }

            function addDevice(width, height) {
                var wBezel = (width * 7.5) / 100;
                var hBezel = (height * 12.5) / 100;
                var totalWidth = width + wBezel;
                var totalHeight = height + hBezel;
                console.log(wBezel);
                console.log(totalHeight);
                var box = new Kinetic.Rect({
                    x: stage.getWidth() / 2,
                    y: stage.getHeight() / 2,
                    width: totalWidth,
                    height: totalHeight,
                    stroke: '#00D2FF',
                    stroke: 'black',
                    strokeWidth: wBezel,
                    draggable: true
                });
               
                boxArray.push(box);
                boxLayer.add(boxArray[devicesCount]);
                stage.add(boxLayer);
            }

            function recieve(msg) {
                var data = msg.split(",");

                switch (data[0]) {
                    case "mas":
                        addDevice(data[1], data[2]);
                        send("ini," + devicesCount);
                        devicesCount++;
                        recenterMaps();
                        break;
                    case "slv":
                        var zoom = parseInt(data[1]);
                        if (zoom != zoomMaster) {
                            zoomMaster = zoom;
                            map.setZoom(zoom);
                        }
                        var lat = data[2];
                        var lng = data[3];
                        var newCenter = new google.maps.LatLng(lat, lng);
                        map.setCenter(newCenter);
                        break;
                }

            }

            function recenterMaps() {
                var center = map.getCenter();
                var centerLat = center.lat();
                var centerLng = center.lng();
                send("pos," + zoomMaster + "," + centerLat.toFixed(8) + "," + centerLng.toFixed(8));
            }

            function send(msg) {
                socket.send(msg);
            }

           
        }
    </script>
</head>
<body onload="initialize()">
    <div id="control"></div>
    <div id="map_canvas" style="width: 100%; height: 100%"></div>
</body>
</html>